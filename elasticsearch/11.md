# 11. 장애 방지를 위한 실시간 모니터링
* 모니터링을 위해 Health 체크 및 내부 모듈의 자세한 상태를 실시간으로 볼 수 있다.
## 11.1 클러스터 Health 체크
### 11.1.1 클러스터 레벨의 Health 체크
* _cluster/health API
* http://10.112.185.140:9200/_cluster/health
```
* status
 - green : 클러스터의 모든 샤드가 정상임을 나타낸다.
 - yellow : 프라이머리 샤드는 정상적으로 할당됐으나, 일부 리플리카 샤드가 정상적으로 할당 X
 - red : 일부 프라이머리 샤드가 정상적으로 할당 X
* relocating_shards
 - 복구를 위해 Relocation 작업 중인 샤드의 개수를 의미. 평상시 대부분 0
* initializing_shards
 - 초기화를 진행 중인 샤드의 개수
```
* status 속성 활용 / yellow 면 동작은 가능하지만, green으로 될 때 까지 모니터링

### 11.1.2 인덱스 레벨의 Health 체크
* _cluster/health?level=indices
* http://10.112.185.140:9200/_cluster/health?level=indices
* 모든 인덱스 정보

### 11.1.3 샤드 레벨의 Health 체크
* _cluster/health?level=shards
* http://10.112.185.140:9200/_cluster/health?level=shards

### 11.1.4 Health 체크 활용하기
```
* 특정 인덱스만 대상으로
 - _cluster/health/인덱스명
 - http://10.112.185.140:9200/_cluster/health/ws_lineworks_kr1_adminapi-2019.07.31

* 인덱스 레벨로 Health 체크
 - http://10.112.185.140:9200/_cluster/health/ws_lineworks_kr1_adminapi-2019.07.31?level=indices

* 샤드 레벨
 - http://10.112.185.140:9200/_cluster/health/ws_lineworks_kr1_adminapi-2019.07.31?level=shards
```

## 11.2 물리적인 클러스터 상태 정보 조회
* ES는 실행시 config 디렉터리 환경설정 정보를 바탕으로 노드를 인스턴스 화 및 자동으로 리소스 분배

### 11.2.1 클러스터 레벨의 물리 상태 조회
* _cluster/state
* http://10.112.185.140:9200/_cluster/state
* metadata 정보, routing_table 정보, Restore/Snapshot 정보 등을 한 눈에 확인할 수 있음.

### 11.2.2 노드 레벨의 물리 상태 조회
* _nodes ( http://10.112.185.140:9200/_nodes )
* _nodes/10.113.147.101   ( http://10.112.185.140:9200/_nodes/10.113.147.101 )
* _nodes/_local ( http://10.112.185.140:9200/_nodes/_local )

```
* Settings 정보
 - elasticsearch.yml 설정 파일 확인 가능
* OS 정보
* Process 정보
 - Memory Lock 이 수행됐는 지 확인 가능
* JVM 정보
* 스레드풀 정보
 - ES 는 CPU 코어 개수를 기반으로 스레드풀 정책을 세운다
* Transport 정보
* Http 정보
* 플러그인 정보
* Modules 정보
```

## 11.3 클러스터에 대한 실시간 모니터링
* 클러스터는 다수의 노드로 구성돼있고, 각 노드는 다시 다수의 샤드로 이뤄진다.
* 물리적인 다수의 샤드가 모여서 논리적인 인덱스를 구성하며, 결과적으로 모든 인덱스들을 하나로 모아 클러스터라고 부른다.
* 클러스터의 본질은 샤드이기 떄문에 기반을 이루는 샤드를 꼼꼼히 살펴야 한다.

### 11.3.1 클러스터 레벨의 실시간 모니터링
* _cluster/stats
* http://10.112.185.140:9200/_cluster/stats
* indices와 node 속성으로 구성

#### 11.3.1.1 클러스터 통계 정보 중 인덱스에 대한 정보
```
* count
 - 인덱스 개수
* shards
* docs
* store
 - adp는 현재 54GB
* fielddata
 - 클러스터가 fielddata를 위해 생성한 메모리 크기
* query_cache
* completion
 - 자동완성을 위해 생성한 메모리 크기
* segments
 - 클러스터 내부 루씬 세그먼트가 사용중인 메모리 정보
 - stored_fields_memory, term_vertor, doc_values 등을 통해 메모리 이슈 분석에 도움줄 수 있음.
```
#### 11.3.1.2 클러스터 통계 정보 중 노드에 대한 정보
```
* count
 - 클러스터에 존재하는 노드의 개수
* versions
* os
 - OS정보 , adp는 현재 메모리 93.38 GB , 4코어
* process
* jvm
* fs
* plugins
* network_types
```

### 11.3.2 노드 레벨의 실시간 모니터링
* _nodes/stats
#### 11.3.2.1 데이터 노드의 통계 정보 중 indices에 대한 정보
```
* docs
* store
 - adp-data-3은 현재 10.87 GB 사용중
* indexing
* get
 - 처리한 get 요청 갯수
* mgerges
 - 데이터노드 내부에서 Merge 작업을 수행한 통계 정보
 - Merge : 루씬에서 많아진 세그먼트들을, 성능 저하를 막기 위해 병합
* refresh
 - 데이터노드 내부에서 refresh 작업을 수행한 통계 정보
 - refresh : 루씬의flush와 같으며, 인덱스 새로고침
* flush
 - 데이터노드 내부에서 flush 작업을 수행한 통게 정보
 - flush : 루씬에서 세그먼트가 생성된 후 검색이 가능하도록 수행
           / 커널 시스템 캐시에만 쓰여져있음
           
* warmer
 - 과거 인덱스 성능을 높이기 위해 사용 / 현재는 폐기 예정으로 사용하지 않음
 
```





```

```




